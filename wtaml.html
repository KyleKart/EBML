<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WTAML Viewer</title>
</head>
<body>
  <script>
    function convertWTAMLtoHTML(wtamlString) {
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(wtamlString, "application/xml");

      if (xmlDoc.querySelector("parsererror")) {
        throw new Error("Invalid WTAML");
      }

      const rootNode = xmlDoc.querySelector("wtaml");
      if (!rootNode) {
        throw new Error("WTAML root element <wtaml> missing");
      }

      const initNode = rootNode.querySelector("init");
      const bodyNode = rootNode.querySelector("body");

      // Collect variables from <var name="...">value</var>
      const variables = {};
      if (initNode) {
        initNode.querySelectorAll("var").forEach(el => {
          const name = el.getAttribute("name");
          const value = el.textContent || "";
          if (name) variables[name] = value;
        });
      }

      // Replace variables in strings like attribute values or text nodes
      function replaceVarsInString(str) {
        return str.replace(/<_([a-zA-Z0-9_-]+)\s*\/>/g, (_, varName) => {
          return variables[varName] ?? "";
        });
      }

      // Recursively process nodes into HTML string
      function processNode(node) {
        if (node.nodeType === Node.TEXT_NODE) {
          // Replace variable tags inside text content
          return replaceVarsInString(node.textContent);
        }

        if (node.nodeType === Node.ELEMENT_NODE) {
          const tagName = node.tagName;

          // Skip <var> tags entirely (they are only for variable declarations)
          if (tagName === "var") return "";

          // If the tag is a self-closing variable tag like <_pageTitle />
          // or named like <_varName>, replace with variable value directly
          if (tagName.startsWith("_")) {
            const varName = tagName.slice(1);
            return variables[varName] ?? "";
          }

          // Start opening tag with attributes
          let html = `<${tagName}`;
          for (const attr of node.attributes) {
            html += ` ${attr.name}="${replaceVarsInString(attr.value)}"`;
          }
          html += ">";

          // For <script> and <style> tags, keep raw text with variable substitution, no further node recursion
          if (tagName === "script" || tagName === "style") {
            html += replaceVarsInString(node.textContent);
          } else {
            // Otherwise process children recursively
            node.childNodes.forEach(child => {
              html += processNode(child);
            });
          }

          // Close tag
          html += `</${tagName}>`;

          return html;
        }

        // For other node types (comments etc), return empty string
        return "";
      }

      // Process <init> into <head>, skipping <var>
      let headHTML = "";
      if (initNode) {
        initNode.childNodes.forEach(child => {
          if (child.nodeType === Node.ELEMENT_NODE && child.tagName === "var") return;
          headHTML += processNode(child);
        });
      }

      // Process <body>
      const bodyHTML = bodyNode ? processNode(bodyNode) : "";

      // Build final HTML document string
      return `<!DOCTYPE html>
<html>
<head>
${headHTML}
</head>
<body>
${bodyHTML}
</body>
</html>`;
    }

    fetch("./main.wtaml")
      .then(response => response.text())
      .then(text => {
        try {
          const html = convertWTAMLtoHTML(text);
          document.open();
          document.write(html);
          document.close();
        } catch (e) {
          document.body.innerText = "Error loading WTAML: " + e.message;
        }
      })
      .catch(err => {
        document.body.innerText = "Error loading WTAML: " + err.message;
      });
  </script>
</body>
</html>